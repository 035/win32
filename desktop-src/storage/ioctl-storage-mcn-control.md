---
title: IOCTL\_STORAGE\_MCN\_CONTROL control code
description: Temporarily enables or disables delivery of the custom PnP events GUID\_IO\_MEDIA\_ARRIVAL and GUID\_IO\_MEDIA\_REMOVAL on a removable-media device.
ms.assetid: 'a2a4a5da-bc2d-4daf-a4ac-7f2a6c10cb70'
keywords: ["IOCTL_STORAGE_MCN_CONTROL control code Storage Devices"]
topic_type:
- apiref
api_name:
- IOCTL_STORAGE_MCN_CONTROL
api_location:
- Ntddstor.h
api_type:
- HeaderDef
---

# IOCTL\_STORAGE\_MCN\_CONTROL control code

Temporarily enables or disables delivery of the custom PnP events GUID\_IO\_MEDIA\_ARRIVAL and GUID\_IO\_MEDIA\_REMOVAL on a removable-media device. This, in turn, enables or disables media change detection (AutoPlay) for the device if the caller has opened the device with FILE\_READ\_ATTRIBUTES access and if the device has AutoPlay enabled in the registry. The caller must not open the device for read or write access or the IOCTL operation will fail. This IOCTL has no effect on the AutoPlay setting in the registry.

A driver for such a removable-media device must do the following:

1.  Keep a count of disable requests, per physical device, in the device object extension.

2.  When called with this IOCTL, if the flag to disable media change detection is set, increment the count; if the flag is clear, decrement the count.

3.  Set the media change event for the device when the media state is changed only if the disable request count is zero.

When the IRP\_MJ\_DEVICE\_CONTROL IRP that contains this IOCTL is passed to the SCSI class driver, the **FileObject** member of the current [**IO\_STACK\_LOCATION**](https://msdn.microsoft.com/library/windows/hardware/ff550659) must point to a valid file object. The SCSI class driver requires a file object for cases where a user-mode application that is disabling or enabling AutoPlay terminates unexpectedly. In such cases, the SCSI class driver uses the file object to reenable media change detection. Because the file object is necessary for proper clean-up, the SCSI class driver will cause the IRP to fail with an error message of STATUS\_INVALID\_PARAMETER if the **FileObject** member of IO\_STACK\_LOCATION does not point to a valid file object. If a user-mode application opens the device, then the I/O manager initializes this member, but kernel-mode driver writers should not assume that **FileObject** will be properly initialized when the IRP is generated by a user-mode application. If, for instance, a user-mode application mistakenly opens the device for either read or write access before sending the IOCTL, then the device control IRP will be routed through the file system, preventing the SCSI class driver and the device driver from directly accessing the device's file object.

## Input Buffer

The buffer at **Irp-&gt;AssociatedIrp.SystemBuffer** contains a Boolean value, with **TRUE** indicating that the driver should disable media change detection.

## Input Buffer Length

The length of a Boolean.

## Output Buffer

None.

## Output Buffer Length

None.

## Status block

The **Information** field is set to zero. The **Status** field is set to STATUS\_SUCCESS, or possibly to STATUS\_BUFFER\_TOO\_SMALL, STATUS\_INVALID\_PARAMETER, or STATUS\_INVALID\_DEVICE\_STATE.

## Requirements



|                   |                                                                                                            |
|-------------------|------------------------------------------------------------------------------------------------------------|
| Header<br/> | <dl> <dt>Ntddstor.h (include Ntddstor.h)</dt> </dl> |



## See also

<dl> <dt>

[**IO\_STACK\_LOCATION**](https://msdn.microsoft.com/library/windows/hardware/ff550659)
</dt> </dl>

 

 

[Send comments about this topic to Microsoft](mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback%20%5Bstorage\storage%5D:%20IOCTL_STORAGE_MCN_CONTROL%20control%20code%20%20RELEASE:%20%283/29/2018%29&body=%0A%0APRIVACY%20STATEMENT%0A%0AWe%20use%20your%20feedback%20to%20improve%20the%20documentation.%20We%20don't%20use%20your%20email%20address%20for%20any%20other%20purpose,%20and%20we'll%20remove%20your%20email%20address%20from%20our%20system%20after%20the%20issue%20that%20you're%20reporting%20is%20fixed.%20While%20we're%20working%20to%20fix%20this%20issue,%20we%20might%20send%20you%20an%20email%20message%20to%20ask%20for%20more%20info.%20Later,%20we%20might%20also%20send%20you%20an%20email%20message%20to%20let%20you%20know%20that%20we've%20addressed%20your%20feedback.%0A%0AFor%20more%20info%20about%20Microsoft's%20privacy%20policy,%20see%20http://privacy.microsoft.com/default.aspx. "Send comments about this topic to Microsoft")






